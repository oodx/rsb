# Jobs & Process Control (FEATURES_JOBS)

Updated: 2025-09-30

Scope
- Background job execution, process management, event system, signal handling, and file locking.
- Provides bash-like job control with a simple, string-biased API.

Module
- `rsb::jobs` (module)
  - `jobs::sleep_ms(ms: u64)` — sleep for N milliseconds
  - `jobs::bench(label, || { ... }) -> Duration` — measure elapsed time, logs info
  - `jobs::start_background(cmd: &str) -> u32` — spawn background job (shell command), return job ID
  - `jobs::wait(job_id, timeout_secs: Option<u64>) -> Result<i32, String>` — wait for job completion
  - `jobs::list_jobs() -> Vec<(u32, String)>` — snapshot of running jobs
  - Process management:
    - `jobs::pid_of(process: &str) -> Option<u32>` — get PID of process by name
    - `jobs::process_exists(process: &str) -> bool` — check if process is running
    - `jobs::kill_pid(pid, signal)` / `kill_process(name, signal)` — terminate processes
  - Locking:
    - `jobs::create_lock(path)` / `remove_lock(path)` — file-based locking
  - Signal handling:
    - `jobs::install_signal_handlers()` — setup SIGINT/SIGTERM handlers
  - Event system:
    - `jobs::EVENT_HANDLERS` — registry for job lifecycle events
    - `jobs::EventData` — event data structure

Macros (module-owned)
- `job!(background: "echo hi")` → job id
- `job!(wait: id)` → exit status (i32)
- `job!(timeout: secs, wait: id)` → exit status
- `job!(list)` → prints `[id] cmd` lines
- `event!(register name, handler)` / `event!(emit name, k => v, ...)` — event registry
- `trap!(handler, on: "SIGINT"|"SIGTERM"|"EXIT"|"COMMAND_ERROR")` — signal handlers
- `benchmark!({ ... })` — inline benchmark
- `sleep!(secs)` / `sleep!(ms: millis)` — inline sleep

Process management macros (in `hosts::macros`, delegate to jobs):
- `pid_of!(process)` — get PID
- `process_exists!(process)` — check if running
- `kill_pid!(pid)` / `kill_pid!(pid, signal: "TERM")` — terminate by PID
- `kill_process!(name)` / `kill_process!(name, signal: "TERM")` — terminate by name
- `lock!(path)`, `unlock!(path)`, `with_lock!(path => { ... })` — file locking

Design
- Background jobs run shell commands via Rust threads with job tracking
- Event system allows subscribing to job lifecycle events
- Signal handlers for graceful shutdown (SIGINT/SIGTERM)
- File-based locking for inter-process synchronization
- Fail-fast policy in macros (exit on error, consistent with RS)
- Logging uses `utils::stderrx(level, msg)` for non-visual builds

Examples
```rust
use rsb::prelude::*;

// Background jobs
let id = job!(background: "sleep 0.1 && echo done");
let status = job!(wait: id);

// Process management
if process_exists!("nginx") {
    let pid = pid_of!("nginx").unwrap();
    kill_pid!(pid, signal: "TERM");
}

// File locking
with_lock!("/tmp/myapp.lock" => {
    // exclusive access
});

// Events and signals
event!(register "job_complete", |event| {
    println!("Job finished: {:?}", event);
});

trap!(|_| { println!("Caught signal!"); }, on: "SIGINT");
```

Testing
- Sanity: `tests/jobs_sanity.rs` → `tests/jobs/sanity.rs`
- UAT: `tests/uat_jobs.rs` → `tests/uat/jobs.rs` (visible demo of sleep/bench/jobs)

Notes
- Jobs module is independent of hosts (peer module)
- Uses `hosts::command` for shell execution (which handles global var expansion)
- Process queries use system commands (pgrep, pkill, etc.)

<!-- feat:jobs -->

_Generated by bin/feat.py --update-doc._

* `src/jobs/core.rs`
  - fn start_background (line 13)
  - fn wait (line 40)
  - fn list_jobs (line 49)

* `src/jobs/macros.rs`
  - macro job! (line 6)
  - macro event! (line 46)
  - macro trap! (line 63)
  - macro benchmark! (line 79)
  - macro sleep! (line 92)

* `src/jobs/mod.rs`
  - pub use core::* (line 14)
  - pub use process::* (line 15)
  - pub use signal::* (line 16)
  - pub use utils::* (line 17)

* `src/jobs/process.rs`
  - struct EventData (line 14)
  - static EVENT_HANDLERS (line 20)
  - struct JobHandle (line 26)
  - static JOBS (line 33)
  - static JOB_COUNTER (line 36)
  - fn wait_on_job (line 39)
  - fn pid_of (line 72)
  - fn process_exists (line 79)
  - fn kill_pid (line 86)
  - fn kill_process (line 93)
  - fn create_lock (line 100)
  - fn remove_lock (line 110)

* `src/jobs/signal.rs`
  - fn install_signal_handlers (line 17)

* `src/jobs/utils.rs`
  - fn sleep_ms (line 10)
  - fn bench (line 15)

<!-- /feat:jobs -->
